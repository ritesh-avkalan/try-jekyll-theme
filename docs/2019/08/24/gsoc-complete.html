<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name = "keywords" content = "fenics, topology optimization, isogeomtric analysis, hpc, phd blog, paraview, latex, computational mechanics, phd tools, parallel computation, python, phase field fracture, phase field topology optimization" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="GSoC complete: FEniCS-The mesh workflow" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the final post for my google summer of code 2019" />
<meta property="og:description" content="This is the final post for my google summer of code 2019" />
<link rel="canonical" href="/2019/08/24/gsoc-complete.html" />
<meta property="og:url" content="/2019/08/24/gsoc-complete.html" />
<meta property="og:site_name" content="Abhinav Gupta" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-08-24T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="GSoC complete: FEniCS-The mesh workflow" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-08-24T00:00:00+05:30","datePublished":"2019-08-24T00:00:00+05:30","description":"This is the final post for my google summer of code 2019","headline":"GSoC complete: FEniCS-The mesh workflow","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/08/24/gsoc-complete.html"},"url":"/2019/08/24/gsoc-complete.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css" type="text/css" media="all" />




  <link rel="shortcut icon" type="image/x-icon" href="/?" />
    <title> 
     
      GSoC complete: FEniCS-The mesh workflow | 
    
    Abhinav Gupta
  </title>


  <!-- MailerLite Universal -->
  <script>
      (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
      .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
      n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
      (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
      ml('account', '325878');
  </script>
  <!-- End MailerLite Universal --><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Abhinav Gupta" /></head><body class="full_width_container"><div class="navbar-container">
    <div class="primary_container ">
        <a class="link home-icon" href="">
                <svg width="76px" height="100%" viewBox="0 0 63 40" >
                    <path d="M29.585,14.07l0.085,1.138l8.46,19.638l0.896,0.906c0.279,0.125 0.564,0.243 0.854,0.355c2.201,0.852 4.618,1.284 7.253,1.284c5.057,0 9.628,-1.101 13.717,-3.286l0.925,-1.544l0,-15.928l-1.75,-1.75l-11.924,0l-1.75,1.75l0,5.016l1.75,1.75l4.63,0c0,0 0,4.518 0,4.518c-0.594,0.254 -1.239,0.453 -1.934,0.6c-1.134,0.24 -2.34,0.358 -3.62,0.358c-1.348,0 -2.57,-0.236 -3.66,-0.726c-1.083,-0.487 -2.014,-1.154 -2.792,-2.005c-0.789,-0.862 -1.394,-1.888 -1.826,-3.07c-0.446,-1.225 -0.664,-2.566 -0.664,-4.021c0,-1.332 0.216,-2.577 0.656,-3.734c0.431,-1.132 1.037,-2.125 1.825,-2.974c0.777,-0.837 1.706,-1.49 2.786,-1.963c1.095,-0.48 2.321,-0.711 3.675,-0.711c1.37,0 2.671,0.226 3.901,0.683c1.182,0.438 2.192,1.054 3.02,1.859l2.463,-0.025l4.092,-4.136l-0.078,-2.536c-1.849,-1.651 -3.946,-2.797 -6.29,-3.44c-2.228,-0.612 -4.611,-0.921 -7.152,-0.921c-2.635,0 -5.052,0.432 -7.253,1.284c-2.243,0.867 -4.172,2.106 -5.792,3.71c-1.617,1.601 -2.887,3.534 -3.802,5.804c-0.275,0.683 -0.509,1.388 -0.701,2.117Z" style="fill-rule:nonzero;"/><path d="M16.141,3.21l-1.604,1.052l-13.552,31.152l1.604,2.448l6.204,0l1.628,-1.107l2.379,-6.021c-0,0 11.141,0 11.141,0c-0,0 2.46,6.038 2.46,6.038l1.62,1.09l6.336,0l1.608,-2.442l-13.42,-31.152l-1.608,-1.058l-4.796,0Zm4.507,19.272l-4.597,0c0,0 2.32,-6.017 2.32,-6.017l2.277,6.017Z" style="fill-rule:nonzero;"/>
                </svg>
        </a>
        <div class="navbar align_menu" style="font-family: Montserrat; font-weight:500">
            <a class="link" href="/pages/blog">Articles</a>
            <a class="link" href="/pages/projects">Projects</a>
            <a class="link nav_desktop" href="/pages/newsletters">Newsletter</a>
            <a class="link" href="/pages/about">About</a>
            <a href="/2019/08/24/gsoc-complete.html" id="theme-toggle" onclick="modeSwitcher()" style="cursor: pointer;">Dark</a>
        </div>
    </div>
</div><main aria-label="Content">
        <div>
            <div class="post_container">
    <div class="post_item_left" style=" padding-bottom:50px; ">
        <div class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

            <head>
                <title>GSoC complete: FEniCS-The mesh workflow</title>
                <script type="text/x-mathjax-config">
                    MathJax.Hub.Config({
                    extensions: ["tex2jax.js"],
                    jax: ["input/TeX", "output/HTML-CSS"],
                    tex2jax: {
                      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                      processEscapes: true
                    },
                    "HTML-CSS": { availableFonts: ["TeX"] }
                  });
                </script>
                <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
            </head>
            <header class="post-header" style="margin-bottom: 60px;">
                <h1 style="font-weight:600; font-size: 46px; margin-top: 120px; " class="post-title p-name" itemprop="name headline">
                    GSoC complete: FEniCS-The mesh workflow
                </h1>
                <p class="post-meta" style="font-size: 16px;">
                    <time class="dt-published" datetime="2019-08-24T00:00:00+05:30" itemprop="datePublished">Aug 24, 2019
                    </time><span style="padding-left:10px;padding-right: 10px;">|</span><span class="post-meta"><a style="font-size:14px;color: var(--text-color);" href="/categories/coding">CODING</a></span><!-- --------------------------------------- -->
                </p>
            </header>
            <hr style="/*position: relative; width: 300%;right:calc(200% - 30px);*/ background: var(--color-1);border: none;height: 1px; margin-bottom: 80px; opacity: 1;">
            <div class="post-content e-content enlarged-char" itemprop="articleBody">
                <p>This is my final post for the GSoC2019 program. The primary goal of the project was to ensure that the meshing package of choice gmsh, DOLFIN, and the preferred visualization package, <a href="http://paraview.org/">Paraview</a> work seamlessly together. The intention was to make improvements to the process of preserving the information about tagged regions of the mesh when importing it to DOLFIN. Two approaches were finalized for the project.</p>

<ul>
  <li>Preserve the string tags when converting from <code class="language-plaintext highlighter-rouge">.msh</code> to <code class="language-plaintext highlighter-rouge">.xdmf</code>.</li>
  <li>Add a constructor to the class MeshValueCollection to support its creation from primitive arrays.</li>
</ul>

<p>The targets were achieved with the following pull requests.</p>

<h3 id="meshio">MESHIO</h3>

<ul>
  <li>
    <p><strong>PR #425</strong></p>

    <p>-Add methods to read and write field_data to XDMF â€“</p>

    <p>merged on Aug 9</p>

    <ul>
      <li>This PR adds methods to preserve the mapping between the string tags and int tags when converting from <code class="language-plaintext highlighter-rouge">.msh</code> to <code class="language-plaintext highlighter-rouge">.xdmf</code>. The idea is to store this mapping inside the <code class="language-plaintext highlighter-rouge">&lt;Information&gt;</code> element of XDMF.</li>
    </ul>
  </li>
</ul>

<h3 id="dolfinx">DOLFINX</h3>

<ul>
  <li>
    <p><strong>PR #439</strong></p>

    <p>â€“ Add function to read Information tag data in XDMF â€“</p>

    <p>open</p>

    <ul>
      <li>This PR extends the functionality of XDMFFile interface with methods <code class="language-plaintext highlighter-rouge">read_information()</code> and <code class="language-plaintext highlighter-rouge">write_information()</code>. The methods are designed to read and write <code class="language-plaintext highlighter-rouge">&lt;Information&gt;</code> tag data of XDMF file format. The syntax is inline with XDMF standard and works well with PARAVIEW.</li>
    </ul>
  </li>
  <li>
    <p><strong>PR #467</strong></p>

    <p>â€“ Method to construct MeshValueCollection from arrays â€“</p>

    <p>open</p>

    <ul>
      <li>This PR extends the functionality of MeshValueCollection class with constructor that supports its creation from primitive arrays.</li>
    </ul>
  </li>
</ul>

<h2 id="demonstration">Demonstration</h2>

<p>We can solve many different forms of PDE on simple as well as complex domains in FEniCS. We have many different prebuilt geometries in FEniCS that helps new users to get up and running with simple FEniCS classes and methods. Even though these built-in meshes provide various methods for their construction and refinement, they are limited to simple shapes. To work with complex geometrical structures it is recommended that the user follows the following mesh workflow.</p>

<p><img src="/assets/images/image-20220211110737972.png" alt="image-20220211110737972" /></p>

<p>In this post, I am going to walk you through the process of solving a PDE in FEniCS. I will demonstrate the whole mesh workflow in detail. The domain under consideration in a unit square as presented below. The domain is made up of two different materials and we need to apply different boundary conditions on all of its edges.</p>

<p><img src="/assets/images/poisson_subdomain.png" alt="poisson_subdomain" /></p>

<h2 id="creating-mesh-in-gmsh">Creating mesh in Gmsh</h2>

<p>There are excellent tutorials and documentation available on the official website of Gmsh. In this small screencast, I have described the process of creation and tagging of the above mesh using gmsh.</p>

<p>https://youtu.be/C4W_28NjF58</p>

<h2 id="convert-mesh-to-xdmf-using-meshio">Convert mesh to XDMF using meshio</h2>

<p>The .msh file created by gmsh could be converted to .xdmf by using the package meshio. The package could be easily installed by the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install meshio
</code></pre></div></div>

<p>Once you have the package installed you can use the following command to convert the mesh to xdmf. Right now FEniCS does not support mixed topologies so you have to individually export mesh entities of different dimension to different XDMF files. Thus for the current mesh, we need to export one mesh of 2D <code class="language-plaintext highlighter-rouge">triangle</code> elements and the other of 1D â€˜lineâ€™ elements.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mesh_of_triangles</span> <span class="o">=</span> <span class="n">meshio</span><span class="p">.</span><span class="nc">Mesh</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">cells</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">triangle</span><span class="sh">'</span><span class="p">:</span> <span class="n">cells</span><span class="p">[</span><span class="sh">'</span><span class="s">triangle</span><span class="sh">'</span><span class="p">]},</span>
                                <span class="n">cell_data</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">triangle</span><span class="sh">'</span><span class="p">:</span> 
                                    <span class="p">{</span><span class="sh">'</span><span class="s">subdomain</span><span class="sh">'</span><span class="p">:</span> 
                                        <span class="n">cell_data</span><span class="p">[</span><span class="sh">'</span><span class="s">triangle</span><span class="sh">'</span><span class="p">]</span>
                                        <span class="p">[</span><span class="sh">'</span><span class="s">gmsh:physical</span><span class="sh">'</span><span class="p">]}},</span>
                                <span class="n">field_data</span><span class="o">=</span><span class="n">field_data</span><span class="p">)</span> 

<span class="n">meshio</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">poisson_subdomain_triangle.xdmf</span><span class="sh">"</span><span class="p">,</span> <span class="n">mesh_of_triangles</span> <span class="p">)</span>

<span class="n">mesh_of_lines</span> <span class="o">=</span> <span class="n">meshio</span><span class="p">.</span><span class="nc">Mesh</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">cells</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">line</span><span class="sh">'</span><span class="p">:</span> <span class="n">cells</span><span class="p">[</span><span class="sh">'</span><span class="s">line</span><span class="sh">'</span><span class="p">]},</span>
                                <span class="n">cell_data</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">line</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">subdomain</span><span class="sh">'</span><span class="p">:</span>
                                    <span class="n">cell_data</span><span class="p">[</span><span class="sh">'</span><span class="s">triangle</span><span class="sh">'</span><span class="p">]</span>
                                    <span class="p">[</span><span class="sh">'</span><span class="s">gmsh:physical</span><span class="sh">'</span><span class="p">]}},</span>
                                <span class="n">field_data</span><span class="o">=</span><span class="n">field_data</span><span class="p">)</span> 

<span class="n">meshio</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">poisson_subdomain_line.xdmf</span><span class="sh">"</span><span class="p">,</span> <span class="n">mesh_of_lines</span> <span class="p">)</span>
</code></pre></div></div>

<h2 id="import-xdmf-to-fenics">Import XDMF to FEniCS</h2>

<p>Once we have the XDMF files we can import them to FEniCS as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nc">XDMFFile</span><span class="p">(</span><span class="n">MPI</span><span class="p">.</span><span class="n">comm_world</span><span class="p">,</span>
              <span class="sh">"</span><span class="s">poisson_subdomain_triangle.xdmf</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">xdmf_infile</span><span class="p">:</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">xdmf_infile</span><span class="p">.</span><span class="nf">read_mesh</span><span class="p">(</span><span class="n">cpp</span><span class="p">.</span><span class="n">mesh</span><span class="p">.</span><span class="n">GhostMode</span><span class="p">.</span><span class="n">none</span><span class="p">)</span>
    <span class="n">tag_info</span> <span class="o">=</span> <span class="n">xdmf_infile</span><span class="p">.</span><span class="nf">read_information_int</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">tag_info</span><span class="p">)</span>
</code></pre></div></div>

<p>FEniCS provide us with two classes <code class="language-plaintext highlighter-rouge">MeshFunction</code> and <code class="language-plaintext highlighter-rouge">MeshValueCollection</code> that help us to mark different mesh entities (vertex, line, facet, cell). The way in which the <code class="language-plaintext highlighter-rouge">MeshFunction</code> class works is that it assigns a marker to every element of a particular dimension (vertex = 0, line = 1, etc.) and then use that marker to differentiate between different regions. <code class="language-plaintext highlighter-rouge">MeshValueCollection</code> class differs from the <code class="language-plaintext highlighter-rouge">MeshFunction</code> class in two ways. First, data does not need to be associated with all entities (only a subset). Second, data is associated with entities through the corresponding cell index and local entity number (relative to the cell), not by global entity index, which means that data may be stored robustly to file. You can get a much better understanding of them by exploring them individually as I have done <a href="https://github.com/iitrabhi/GSoC2019/blob/master/Notebooks/Understanding MeshFunction and MeshValueCollection.ipynb">here</a>.</p>

<h2 id="visualize-the-solution">Visualize the solution</h2>

<p>We could visualize the solution using opensource package paraview. Once again the filetype of choice is XDMF and we can easily write the solution to the file using the <strong>write</strong> method of class <strong>XDMFFile</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nc">XDMFFile</span><span class="p">(</span><span class="n">dolfin</span><span class="p">.</span><span class="n">MPI</span><span class="p">.</span><span class="n">comm_world</span><span class="p">,</span> <span class="sh">"</span><span class="s">output.xdmf</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">xdmf_outfile</span><span class="p">:</span>
    <span class="n">xdmf_outfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</code></pre></div></div>

<p>You can find the complete code <a href="https://github.com/iitrabhi/dolfinx/blob/iitrabhi/mvc-xdmf/python/demo/poisson-subdomain/demo_poisson_subdomain.py">here</a>.</p>

<h2 id="summary">Summary</h2>

<p>The mesh workflow of FEniCS is not as straight forward as that of some commercial packages like Abaqus or Ansys. But, FEniCS provides you with greater flexibility in creating a computational model and would also help you understand the mathematics behind FEM. I believe that if understood and used properly, FEniCS could help researchers code and test out their mathematical models with a speed and ease that is just simply not possible with other packages.</p>

            </div>
            <div class="PageNavigation">
                
                <a class="button button-prev" href="/2019/07/22/complete-phase-two.html" title="FEniCS: Completion of phase two">&laquo; Previous</a>
                
                
                <a class="button button-next" href="/2020/07/07/parallel-for-loop.html" title="Parallelizing for loop in python with MPI.">Next &raquo;</a>
                
            </div>
            <!-- ----------------------------------------------------------- -->
            <hr style="/*position: relative; width: 300%;right:calc(200% - 30px);*/ background: var(--color-1);border: none;height: 1px; margin-bottom: 80px; opacity: 1;">
            <div class="flexbox_container_two_col flexbox_container_flip " style="padding-top: 50px;padding-bottom: 50px;">
                <div class="flexbox_item">
                    <div>
                        <p style="font-size:36px; font-family: Montserrat; font-weight: bold; line-height: 1.2; ">Newsletter</p>
                        <p style="font-size:16px; padding-top: 20px; padding-bottom: 30px;">"<em><strong>Quality Research:</strong> A weekly newsletter covering ideas and tools for better academic research.</em>" </p>
                        <a class="ml-onclick-form button button-hello" href="javascript:void(0)" onclick="ml('show', 'uSsXyN', true)">Try the free newsletter</a>
                    </div>
                </div>
                <div class="flexbox_item">
                    <div class="abhi-icon" style="vertical-align: middle;     float: right;"><object data="/assets/svg/newsletter.svg" width="80%" style="pointer-events: none;"> </object></div>
                </div>
            </div>
            <!-- ----------------------------------------------------------- -->
        </div>
    </div>
    <div class="post_item_right hide_mobile">
        <p style="padding-top:200px; font-size: 14px; font-family: Montserrat;">ABOUT THE AUTHOR</p>
        <hr style="/*position: relative; width: 300%;right:calc(200% - 30px);*/ background: var(--color-1);border: none;height: 1px; margin-bottom: 40px;">
        <p style="margin-bottom:20px;font-size: 14px;">Hi, I am <strong>Abhinav Gupta</strong>. I am a researcher at Vanderbilt University, USA. I create content to help you become effective in producing quality research. If you are interested in research, academia, or computational mechanics, make sure to follow me. </p>
        <div style="margin-top:50px;">
            <ul class="social-media-list" style="font-size: 14px;">
                <li>
                    <a class="black-link" href="https://www.linkedin.com/in/abhiguptaio/" target="_blank" rel="noopener noreferrer">[LinkedIn]</a>
                </li>
                <li>
                    <a class="black-link" href="https://github.com/iitrabhi" target="_blank" rel="noopener noreferrer"> [Github]</a>
                </li>
                <li>
                    <a class="black-link" href="https://www.researchgate.net/profile/Abhinav_Gupta52" target="_blank" rel="noopener noreferrer">[RG]</a>
                </li>
                <li>
                    <p>ðŸ‘‹</p>
                </li>
            </ul>
        </div>
        <a class="hover_highlight" style="font-size: 14px;" href="/pages/about">Click here to learn more â†’</a>
        <p style="margin-bottom:50px"></p>
    </div>
</div>
        </div>
    </main>
<div style="min-height: 500px;background-color: #000; width:100%">
    <div class="primary_container">
        <div style="flex: 60%; ">
            <p style="font-family:Montserrat; color:#fff; font-weight:700; margin-top: 50px;">ABHI GUPTA</p>
        </div>
        <div class="hide_mobile" style="flex: 20%;">
            <p style="font-family:Montserrat; color:#888; font-weight:700; margin-top: 50px;">Categories</p>
             <p><a href="/categories/coding"  style="color:#ddd; font-size: 16px;">Coding</a></p>
            <p><a href="/categories/presentation"  style="color:#ddd;font-size: 16px;">Presentation</a></p>
            <p><a href="/categories/productivity"  style="color:#ddd;font-size: 16px;">Productivity</a></p>
        </div>
        <div style="flex: 20%; ">
            <p style="font-family:Montserrat; color:#888; font-weight:700; margin-top: 50px;">Links</p>
           
            <p><a href="https://twitter.com/abhiguptaio"  style="color:#ddd;font-size: 16px;">Twitter</a></p>
            <p><a href="https://www.youtube.com/channel/UCpj8oznjjLwVe5KHOGNrvnQ" style="color:#ddd;font-size: 16px;">YouTube</a></p>

             <p><a href="https://github.com/iitrabhi" style="color:#ddd;font-size: 16px;">GitHub</a></p>
             <p><a href="https://www.linkedin.com/in/abhiguptaio/"  style="color:#ddd;font-size: 16px;">LinkedIn</a></p>

            <p><a href="https://scholar.google.com/citations?user=UfWvIkEAAAAJ"  style="color:#ddd;font-size: 16px;">Google Scholar</a></p>
            <p><a href="https://www.researchgate.net/profile/Abhinav-Gupta-38"  style="color:#ddd;font-size: 16px;">Research Gate</a></p>
            
        </div>
    </div>
</div>
<script src="/assets/js/mode_switcher.js" type="text/javascript"></script>
    <script src="/assets/js/code_block.js" type="text/javascript"></script>
</body>

</html>